<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Pagamentos Online ‚Ä¢ Agenda F√°cil</title>

<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#ff6a00">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary:#ff6a00;
  --bg:#f4f6fb;
  --card:#ffffff;
  --border:#e5e7eb;
  --text:#111827;
  --muted:#6b7280;
  --success:#16a34a;
  --blue:#2563eb;
}

*{
  box-sizing:border-box;
  font-family:Inter;
}

body{
  background:linear-gradient(180deg,#fff,#f4f6fb);
  padding:16px;
  opacity:0;
  animation:fade .6s ease forwards;
}

@keyframes fade{to{opacity:1}}

.card{
  background:var(--card);
  border-radius:26px;
  padding:20px;
  box-shadow:0 18px 40px rgba(0,0,0,.1);
  margin-bottom:18px;
  animation:cardIn .6s cubic-bezier(.16,.84,.44,1) forwards;
}

@keyframes cardIn{
  from{opacity:0;transform:translateY(20px)}
  to{opacity:1;transform:translateY(0)}
}

/* ================= CARD MERCADO PAGO ================= */
.card.mp-bg{
  position:relative;
  overflow:hidden;
  background:
    linear-gradient(
      to bottom,
      rgba(0,0,0,.45) 0%,
      rgba(0,0,0,.25) 30%,
      rgba(255,255,255,.55) 55%,
      rgba(255,255,255,.9) 70%,
      #ffffff 85%
    ),
    url("logomp.png");
  background-size:cover;
  background-position:center top;
}

.card.mp-bg > *{
  position:relative;
  z-index:2;
}

/* ================= TEXTOS ================= */
h1{
  font-size:20px;
  font-weight:800;
  margin-bottom:6px;
  color:#111;
  text-align:center;
}

h2{
  font-size:16px;
  font-weight:800;
  margin-bottom:6px;
}

p{
  font-size:14px;
  color:#374151;
  margin-bottom:14px;
  line-height:1.45;
}

/* ================= STEPS ================= */
.steps{
  margin:14px 0;
  padding-left:16px;
}

.steps li{
  font-size:13px;
  margin-bottom:8px;
  color:#111;
}

.steps a{
  color:var(--blue);
  font-weight:700;
  text-decoration:underline;
}

/* ================= INPUT ================= */
input{
  width:100%;
  padding:13px 14px;
  border-radius:14px;
  border:1px solid var(--border);
  font-size:14px;
  margin-bottom:12px;
}

/* ================= BOT√ïES ================= */
.btn-row{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:10px;
}

button{
  height:44px;
  border:none;
  border-radius:999px;
  font-weight:700;
  font-size:13px;
  cursor:pointer;
  transition:.2s;
}

button:active{transform:scale(.97)}

.btn-primary{
  background:linear-gradient(135deg,#ff6a00,#ff9a57);
  color:#fff;
}

.btn-whats{
  background:#dcfce7;
  color:#15803d;
}

/* ================= STATUS ================= */
.status{
  padding:14px;
  border-radius:14px;
  font-size:14px;
  font-weight:700;
  background:#ecfdf5;
  color:var(--success);
  text-align:center;
  margin-top:10px;
}

/* ================= LINK BOX ================= */
.link-box{
  border:2px dashed var(--border);
  border-radius:14px;
  padding:12px;
  font-size:12px;
  background:#fafafa;
  word-break:break-all;
  margin-bottom:10px;
}

/* ================= MODAL ================= */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.65);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.modal.show{display:flex}

.modal-box{
  background:#fff;
  width:92%;
  max-width:420px;
  border-radius:24px;
  padding:16px;
}

.modal-box video{
  width:100%;
  border-radius:16px;
  margin-bottom:10px;
}

.modal-actions{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}

.btn-close{
  background:#e5e7eb;
  color:#111;
}


</style>
</head>

<body>

<!-- ================= LINK DA LOJA ================= -->
<div class="card">
  <h2 id="nomeLoja">Sua loja</h2>
  <p>Compartilhe este link com seus clientes</p>

  <div class="link-box" id="linkLoja">Carregando‚Ä¶</div>

  <button onclick="copiarLink()">üìã Copiar link</button>
  <button class="whats" style="margin-top:10px" onclick="compartilharWhats()">üì≤ Compartilhar no WhatsApp</button>
</div>

<!-- ================= MERCADO PAGO ================= -->
<div class="card mp-bg">

  <div class="mp-header">
    <h1>Pagamentos Online</h1>
  </div>

  <p id="mensagemLoja"></p>

  <ol class="steps">
    <li>1Ô∏è‚É£ Assista ao v√≠deo explicativo <a onclick="abrirVideo()">clique aqui</a></li>
    <li>2Ô∏è‚É£ Copie o <b>Access Token de PRODU√á√ÉO</b></li>
    <li>‚ùå N√£o utilize token de teste</li>
  </ol>

  <div id="formToken">
<div class="btn-row">
  <button class="btn-primary" onclick="salvarToken()">
    Ativar pagamentos
  </button>

  <button class="btn-whats" onclick="suporte()">
    Suporte
  </button>
</div>

  </div>

  <div id="statusAtivo" class="status" style="display:none">
    ‚úÖ Pagamentos online ativados com sucesso
  </div>

  <button class="whats" style="margin-top:14px" onclick="suporte()">üí¨ Falar com suporte</button>

</div>

<!-- ================= MODAL V√çDEO ================= -->
<div class="modal" id="modalVideo">
  <div class="modal-box">
    <video controls src="" id="videoPlayer"></video>

    <p style="font-size:13px;color:#6b7280;margin-bottom:12px">
      Neste v√≠deo voc√™ ver√° exatamente onde encontrar o Access Token de produ√ß√£o no Mercado Pago.
    </p>

    <div class="modal-actions">
      <button onclick="prosseguir()">Prosseguir</button>
      <button class="btn-close" onclick="fecharVideo()">Fechar</button>
    </div>
  </div>
</div>

<script>
const VIDEO_URL = "https://egxjgmzukjyyxmkukwub.supabase.co/storage/v1/object/public/videosfront/Gravando%202026-01-06%20195208.mp4";
const LINK_PROSSEGUIR = "https://www.mercadopago.com.br/developers/panel/credentials";

const sb = supabase.createClient(
  "https://egxjgmzukjyyxmkukwub.supabase.co",
  "sb_publishable_EWwdrLOUk6KDHZGLuh4uRg_QDRtLeFi"
);

let lojaId, linkPublico, nomeLoja;

(async ()=>{
  const {data:{session}} = await sb.auth.getSession();
  if(!session) return location.href="login.html";

  lojaId = session.user.id;
  linkPublico = `${location.origin}/loja.html?l=${lojaId}`;
  linkLoja.innerText = linkPublico;

  const {data} = await sb
    .from("user_profile")
    .select("negocio,pagamento_online_ativo")
    .eq("user_id", lojaId)
    .single();

  nomeLoja = data?.negocio || "sua loja";
  nomeLojaEl = document.getElementById("nomeLoja");
  nomeLojaEl.innerText = nomeLoja;

  mensagemLoja.innerText =
    `Ative os pagamentos online para que os clientes da ${nomeLoja} possam pagar direto pela agenda.`;

  if(data?.pagamento_online_ativo){
    formToken.style.display="none";
    statusAtivo.style.display="block";
  }
})();

function copiarLink(){
  navigator.clipboard.writeText(linkPublico);
  alert("Link copiado com sucesso ‚úÖ");
}

function compartilharWhats(){
  const msg = `Ol√° üòä\n\nAcesse a ${nomeLoja} e pague online:\n${linkPublico}`;
  window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`,"_blank");
}

function abrirVideo(){
  videoPlayer.src = VIDEO_URL;
  modalVideo.classList.add("show");
}
function fecharVideo(){
  videoPlayer.pause();
  modalVideo.classList.remove("show");
}
function prosseguir(){
  window.open(LINK_PROSSEGUIR,"_blank");
}

function tokenValido(t){
  return t.startsWith("APP_USR-") && t.length > 60;
}

async function salvarToken(){
  const t = token.value.trim();
  if(!tokenValido(t)) return alert("Token inv√°lido");

  const res = await fetch("/api/salvar-credencial-mp",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ loja_id: lojaId, mp_access_token: t })
  });

  if(!res.ok) return alert("Erro ao ativar integra√ß√£o");

  formToken.style.display="none";
  statusAtivo.style.display="block";
}

function suporte(){
  window.open("https://wa.me/5575998112535","_blank");
}
</script>

</body>
</html>
