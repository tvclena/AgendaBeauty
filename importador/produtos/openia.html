<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Importador SQL â€¢ CLENA</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
*{box-sizing:border-box;font-family:Inter}
body{margin:0;background:#f4f6fb;color:#111827}

:root{
  --primary:#ff6a00;
  --border:#e5e7eb;
  --card:#fff;
  --muted:#6b7280;
  --ok:#16a34a;
  --warn:#f59e0b;
  --err:#dc2626;
}

.container{
  max-width:1200px;
  margin:40px auto;
  background:var(--card);
  border-radius:18px;
  box-shadow:0 15px 40px rgba(0,0,0,.08);
  padding:30px;
}

h1{margin:0;font-size:24px;font-weight:800}
.subtitle{font-size:13px;color:var(--muted);margin-bottom:18px}

input,button{
  height:44px;
  border-radius:12px;
  border:1px solid var(--border);
  padding:0 14px;
  font-size:14px;
}

button{
  cursor:pointer;
  font-weight:800;
  border:none;
}

.btn-primary{
  background:linear-gradient(135deg,#ff6a00,#ff9a57);
  color:#fff;
}

.btn-secondary{
  background:#0f172a;
  color:#fff;
}

.btn-danger{
  background:#dc2626;
  color:#fff;
}

.row{display:flex;gap:12px;flex-wrap:wrap}

.box{
  border:2px dashed var(--border);
  border-radius:16px;
  padding:30px;
  text-align:center;
  cursor:pointer;
}
.box:hover{border-color:var(--primary)}

.hidden{display:none}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
  font-size:12px;
}
th,td{
  border-bottom:1px solid var(--border);
  padding:8px;
  text-align:left;
}
th{background:#f9fafb;font-weight:800}

.tag{
  padding:3px 8px;
  border-radius:999px;
  font-size:10px;
  font-weight:800;
  color:#fff;
}
.ok{background:var(--ok)}
.warn{background:var(--warn)}
.err{background:var(--err)}

pre{
  background:#020617;
  color:#e5e7eb;
  padding:20px;
  border-radius:16px;
  max-height:400px;
  overflow:auto;
  font-size:12px;
  white-space:pre-wrap;
}

.footer{
  display:flex;
  gap:12px;
  margin-top:20px;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="container" id="login">
  <h1>Acesso restrito</h1>
  <div class="subtitle">Importador SQL protegido</div>
  <input type="password" id="senha" placeholder="Senha de acesso">
  <button class="btn-primary" onclick="login()">Entrar</button>
</div>

<!-- APP -->
<div class="container hidden" id="app">
  <div class="row" style="justify-content:space-between">
    <div>
      <h1>Importador SQL</h1>
      <div class="subtitle">Planilha â†’ SQL Supabase</div>
    </div>
    <button class="btn-danger" onclick="logout()">Sair</button>
  </div>

  <label class="box">
    <input type="file" id="file" accept=".xlsx" hidden>
    ðŸ“„ Clique para selecionar a planilha
  </label>

  <div class="row" style="margin-top:14px">
    <button class="btn-primary" onclick="processar()">Gerar SQL</button>
    <button class="btn-secondary" onclick="copiar()">Copiar SQL</button>
    <button class="btn-secondary" onclick="baixar()">Baixar .sql</button>
  </div>

  <table id="preview" class="hidden"></table>
  <pre id="sql" class="hidden"></pre>
</div>

<script>
/* ===== AUTH ===== */
if(sessionStorage.getItem("auth")==="ok") liberar();

async function login(){
  const senha=document.getElementById("senha").value;
  const res=await fetch("/api/auth-importador",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({password:senha})
  });
  if(!res.ok){alert("Senha invÃ¡lida");return;}
  sessionStorage.setItem("auth","ok");
  liberar();
}

function liberar(){
  login.classList.add("hidden");
  app.classList.remove("hidden");
}

function logout(){
  sessionStorage.clear();
  location.reload();
}

/* ===== IMPORT ===== */
let SQL_FINAL="";

async function processar(){
  const file=document.getElementById("file").files[0];
  if(!file){alert("Selecione a planilha");return;}

  const buf=await file.arrayBuffer();
  const wb=XLSX.read(buf);
  const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

  const res=await fetch("/api/importar-produtos",{method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({rows})
  });

  const json=await res.json();
  SQL_FINAL=json.sql;

  document.getElementById("preview").innerHTML=json.preview;
  document.getElementById("preview").classList.remove("hidden");
  document.getElementById("sql").textContent=json.sql;
  document.getElementById("sql").classList.remove("hidden");
}

function copiar(){
  navigator.clipboard.writeText(SQL_FINAL);
  alert("SQL copiado");
}

function baixar(){
  const blob=new Blob([SQL_FINAL],{type:"text/sql"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="importacao.sql";
  a.click();
}
</script>

</body>
</html>
