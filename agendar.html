<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Agendar Serviço</title>


<meta name="viewport"
  content="width=device-width,
  initial-scale=1,
  maximum-scale=1,
  user-scalable=no,
  viewport-fit=cover">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary:#ff6a00;
  --bg:#f4f6fb;
  --card:#fff;
  --border:#e5e7eb;
  --text:#111827;
}

*{box-sizing:border-box;font-family:Inter}
html,body{margin:0;background:var(--bg)}

.header{
  height:56px;
  background:#fff;
  border-bottom:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
  position:sticky;
  top:0;
}

.section{
  padding:18px 14px;
}

.title{
  font-weight:800;
  margin-bottom:10px;
}

.services{
  display:flex;
  gap:16px;
  overflow-x:auto;
}
.services::-webkit-scrollbar{display:none}

.service{
  min-width:220px;
  background:#fff;
  border-radius:22px;
  overflow:hidden;
  box-shadow:0 18px 44px rgba(0,0,0,.14);
  cursor:pointer;
}

.service img{
  width:100%;
  height:140px;
  object-fit:cover;
}

.service-info{
 padding:12px;
}

.service-name{font-weight:800;font-size:17px}
.service-price{color:var(--primary);font-weight:700;margin-top:6px}

.grid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:14px;
}

.item{
  background:#fff;
  border:1px solid var(--border);
  border-radius:16px;
  padding:16px 0;
  text-align:center;
  font-weight:800;
  cursor:pointer;
}

.item:hover{
  background:#fff3ea;
}

.msg-final{
  background:#fff;
  border-radius:22px;
  padding:18px;
  box-shadow:0 18px 44px rgba(0,0,0,.18);
  font-weight:700;
}

.hidden {
  display: none;
}

.selected {
  border: 2px solid #2563eb !important; /* azul */
}
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
.msg-final button{
  border:none;
  border-radius:12px;
  padding:12px;
  font-weight:700;
  cursor:pointer;
}

.msg-final button:first-child{
  background:#2563eb;
  color:#fff;
}

.msg-final button:last-child{
  background:#e5e7eb;
}
.days-scroll{
  display:flex;
  gap:14px;
  overflow-x:auto;
  padding-bottom:6px;
}
.days-scroll::-webkit-scrollbar{display:none}

.days-scroll .item{
  min-width:70px;
}


</style>
</head>

<body>

<div class="header">Agendar Serviço</div>

<div class="section">
  <div class="title">Escolha um serviço</div>
  <div class="services" id="services"></div>
</div>

<div class="section hidden" id="secDays">
  <div class="title">Escolha a data</div>
  <div class="days-scroll" id="days"></div>
</div>


<div class="section hidden" id="secTimes">
  <div class="title">Escolha o horário</div>
  <div class="grid" id="times"></div>
</div>


<div class="section" id="final"></div>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
  "https://egxjgmzukjyyxmkukwub.supabase.co",
  "sb_publishable_EWwdrLOUk6KDHZGLuh4uRg_QDRtLeFi"
);

/* ================= PARAMS ================= */
const lojaId = new URLSearchParams(location.search).get("l");
const servicoPreSelecionado =
  new URLSearchParams(location.search).get("servico");

/* ================= ESTADO ================= */
let duracao = 0;
let dados = {};

let MAPA_AGENDAMENTOS = {};
let DIAS_VALIDOS = [];

let carregandoDias = false;
let page = 0;
const PAGE_SIZE = 10;

/* ================= UTILS ================= */
const toMin = h => {
  const [a, b] = h.split(":").map(Number);
  return a * 60 + b;
};

const toHour = m =>
  String(Math.floor(m / 60)).padStart(2, "0") +
  ":" +
  String(m % 60).padStart(2, "0");

const hojeLocal = () => new Date().toISOString().split("T")[0];

/* ================= SERVIÇOS ================= */
async function carregarServicos() {
  const { data } = await sb
    .from("produtos_servicos")
    .select("id,nome,preco,imagem_url,duracao_minutos")
    .eq("user_id", lojaId)
    .eq("ativo", true)
    .order("ordem_exibicao", { ascending: true, nullsLast: true });

  document.getElementById("services").innerHTML = data.map(s => `
    <div class="service" data-id="${s.id}"
      onclick="selecionarServico('${s.id}',${s.duracao_minutos},'${s.nome}',${Number(s.preco)})">
      <img src="${s.imagem_url || 'https://via.placeholder.com/400'}">
      <div class="service-info">
        <div class="service-name">${s.nome}</div>
        <div class="service-price">R$ ${s.preco}</div>
      </div>
    </div>
  `).join("");

  if (servicoPreSelecionado) {
    const s = data.find(x => x.id === servicoPreSelecionado);
    if (s) selecionarServico(s.id, s.duracao_minutos, s.nome, s.preco);
  }
}

/* ================= DIAS (PAGINADO) ================= */
async function carregarDiasLazy() {
  if (carregandoDias) return;
  carregandoDias = true;

  const { data: agenda } = await sb
    .from("agenda_loja")
    .select("data,horarios")
    .eq("user_id", lojaId)
    .eq("fechado", false)
    .gte("data", hojeLocal())
    .order("data")
    .range(page * PAGE_SIZE, page * PAGE_SIZE + PAGE_SIZE - 1);

  if (!agenda || agenda.length === 0) {
    carregandoDias = false;
    return;
  }

  const datas = agenda.map(a => a.data);

  const { data: ags } = await sb
    .from("agendamentos")
    .select("data,hora_inicio,hora_fim")
    .eq("user_id", lojaId)
    .in("data", datas);

  ags?.forEach(a => {
    if (!MAPA_AGENDAMENTOS[a.data]) MAPA_AGENDAMENTOS[a.data] = [];
    MAPA_AGENDAMENTOS[a.data].push([
      toMin(a.hora_inicio),
      toMin(a.hora_fim)
    ]);
  });

  for (const d of agenda) {
    let blocos;
    try {
      blocos = JSON.parse(d.horarios);
    } catch { continue; }

    const ocupados = MAPA_AGENDAMENTOS[d.data] || [];
    let livre = false;

    for (const b of blocos) {
      let s = toMin(b.inicio);
      let e = toMin(b.fim);

      while (s + duracao <= e) {
        if (!ocupados.some(o => !(s + duracao <= o[0] || s >= o[1]))) {
          livre = true;
          break;
        }
        s += duracao;
      }
      if (livre) break;
    }

    if (livre) {
      DIAS_VALIDOS.push(d);
      document.getElementById("days").insertAdjacentHTML("beforeend", `
        <div class="item" onclick="selecionarDia(${DIAS_VALIDOS.length - 1})">
          <div style="font-size:18px">${Number(d.data.split("-")[2])}</div>
          <div style="font-size:12px;color:#6b7280">
            ${["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"][new Date(d.data).getDay()]}
          </div>
        </div>
      `);
    }
  }

  page++;
  carregandoDias = false;
}

/* ================= FLUXO ================= */
function selecionarServico(id, dur, nome, preco) {
  duracao = dur;
  dados = { servico: id, servico_nome: nome, valor_servico: preco };

  DIAS_VALIDOS = [];
  MAPA_AGENDAMENTOS = {};
  page = 0;

  document.getElementById("days").innerHTML = "";
  document.getElementById("times").innerHTML = "";

  document.getElementById("secDays").classList.remove("hidden");
  document.getElementById("secTimes").classList.add("hidden");

  carregarDiasLazy();
}

function selecionarDia(index) {
  const dia = DIAS_VALIDOS[index];
  const blocos = JSON.parse(dia.horarios);
  const ocupados = MAPA_AGENDAMENTOS[dia.data] || [];

  let slots = [];

  blocos.forEach(b => {
    let s = toMin(b.inicio);
    let e = toMin(b.fim);
    while (s + duracao <= e) {
      if (!ocupados.some(o => !(s + duracao <= o[0] || s >= o[1]))) {
        slots.push(toHour(s));
      }
      s += duracao;
    }
  });

  document.getElementById("secTimes").classList.remove("hidden");
  document.getElementById("times").innerHTML =
    slots.length
      ? slots.map(h => `<div class="item">${h}</div>`).join("")
      : `<div style="grid-column:1/-1;text-align:center;color:#6b7280">Sem horários</div>`;
}

/* ================= INIT ================= */
carregarServicos();

document.getElementById("days").addEventListener("scroll", e => {
  const el = e.target;
  if (el.scrollLeft + el.clientWidth >= el.scrollWidth - 60) {
    carregarDiasLazy();
  }
});
</script>

<!-- MODAL CLIENTE -->
<div id="clienteModal" class="hidden">
  <div class="overlay" onclick="fecharModal()"></div>

  <div class="msg-final" style="max-width:380px">
    <h2 style="margin-bottom:6px">Seus dados</h2>
    <p style="color:#6b7280;margin-bottom:10px">
      Precisamos dessas informações para confirmar seu agendamento
    </p>

    <input id="cliNome" placeholder="NOME COMPLETO" style="text-transform:uppercase;width:100%;margin-bottom:10px">
    <input id="cliWhats" placeholder="WHATSAPP" inputmode="numeric" style="width:100%;margin-bottom:10px">
    <input id="cliEmail" placeholder="E-MAIL (opcional)" style="width:100%;margin-bottom:12px">

    <button onclick="salvarCliente()" style="width:100%">
      Salvar e continuar
    </button>
  </div>
</div>

</body>
</html>
