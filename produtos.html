<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Produtos & Serviços • AgendaBeauty</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://unpkg.com/cropperjs/dist/cropper.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/cropperjs/dist/cropper.js"></script>

<style>
/* ===== BASE (IGUAL AO SEU) ===== */
:root{--primary:#ff6a00;--bg:#f5f7fb;--card:#fff;--border:#e5e7eb;--radius:14px;--danger:#dc2626;--muted:#6b7280;--shadow:0 10px 28px rgba(0,0,0,.1)}
*{margin:0;padding:0;box-sizing:border-box;font-family:Inter}
body{background:var(--bg);padding:20px;overflow:hidden}
.header{max-width:1700px;margin-bottom:12px}
.header h1{font-size:26px;font-weight:800}
.header span{color:var(--primary)}
.header p{font-size:12px;color:var(--muted)}
.container{max-width:1700px;display:grid;grid-template-columns:400px 1fr;gap:20px;height:calc(100vh - 160px)}
.card{background:var(--card);border-radius:14px;padding:16px;box-shadow:var(--shadow);display:flex;flex-direction:column}
input,textarea,select{width:100%;height:36px;border-radius:10px;border:1px solid var(--border);padding:0 10px;font-size:12px;margin-bottom:8px}
textarea{height:auto;padding:8px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
button{height:40px;border:none;border-radius:22px;background:linear-gradient(135deg,#ff6a00,#ff9a57);color:#fff;font-weight:700;cursor:pointer}
.grid{flex:1;display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;overflow:auto}
.item{background:#fff;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.1);cursor:pointer}
.image{height:80px;background:#eee;display:flex;align-items:center;justify-content:center}
.image img{width:100%;height:100%;object-fit:cover}
.item-body{padding:10px}
.actions{font-size:11px;color:var(--primary);font-weight:700}

/* ===== UPLOAD ===== */
.upload{border:2px dashed var(--border);border-radius:10px;padding:10px;text-align:center;cursor:pointer}
.upload img{width:100%;height:90px;object-fit:cover;border-radius:8px}

/* ===== MODAL ===== */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:999}
.modal-box{width:900px;max-height:90vh;background:#fff;border-radius:14px;padding:16px;overflow:auto}
.modal-header{display:flex;gap:16px}
.modal-header img{width:140px;height:180px;object-fit:cover;border-radius:8px}

/* ===== OVERLAY ===== */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000}
.overlay div{background:#fff;padding:20px;border-radius:12px;font-weight:800}

/* ===== CROP ===== */
.crop-modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1001}
.crop-box{background:#fff;padding:16px;border-radius:14px;width:420px}
.crop-box img{max-width:100%}
</style>
</head>

<body>

<div class="header">
  <h1>Produtos & <span>Serviços</span></h1>
  <p>Gerencie serviços, produtos, estoque, promoções e preços</p>
</div>

<div class="container">

<!-- ===== CRIAR ===== -->
<div class="card">
<h3>Cadastrar item</h3>

<label class="upload">
<img id="preview" style="display:none">
<span id="uploadText">Selecionar imagem</span>
<input type="file" id="imagem" hidden>
</label>

<select id="tipo"><option>SERVICO</option><option>PRODUTO</option></select>
<input id="nome" placeholder="Nome">
<textarea id="descricao" placeholder="Descrição"></textarea>
<div class="row"><input id="preco" placeholder="Preço"><input id="custo" placeholder="Custo"></div>
<button onclick="salvar()">Salvar</button>
</div>

<!-- ===== LISTA ===== -->
<div class="card">
<div class="grid" id="lista"></div>
</div>

</div>

<!-- ===== MODAL EDITAR ===== -->
<div id="modal" class="modal">
<div class="modal-box">

<div class="modal-header">
<img id="mPreview">
<div style="flex:1">
<label>Nova imagem</label>
<input type="file" id="mImagem">
</div>
</div>

<input id="mNome">
<textarea id="mDescricao"></textarea>
<div class="row"><input id="mPreco"><input id="mCusto"></div>

<div style="display:flex;gap:10px;margin-top:14px">
<button onclick="salvarEdicao()">Salvar</button>
<button onclick="fecharModal()">Cancelar</button>
<button onclick="excluir()">Excluir</button>
</div>

</div>
</div>

<!-- ===== OVERLAY ===== -->
<div id="overlay" class="overlay"><div>Salvando...</div></div>

<!-- ===== CROP ===== -->
<div id="cropModal" class="crop-modal">
<div class="crop-box">
<img id="cropImg">
<button onclick="confirmarCrop()">Confirmar</button>
<button onclick="cancelarCrop()">Cancelar</button>
</div>
</div>

<script>
const sb=supabase.createClient(
"https://egxjgmzukjyyxmkukwub.supabase.co",
"sb_publishable_EWwdrLOUk6KDHZGLuh4uRg_QDRtLeFi"
);

let itens=[], atual=null, userId=null, cropper=null, croppedBlob=null;

(async()=>{
const {data:{session}}=await sb.auth.getSession();
if(!session) return;
userId=session.user.id;
carregar();
})();

async function carregar(){
const {data}=await sb.from("produtos_servicos").select("*").eq("user_id",userId);
itens=data||[];
render();
}

function render(){
lista.innerHTML="";
itens.forEach(i=>{
const d=document.createElement("div");
d.className="item";
d.ondblclick=()=>abrirModal(i);
d.innerHTML=`
<div class="image">${i.imagem_url?`<img src="${i.imagem_url}">`:i.nome[0]}</div>
<div class="item-body">
<strong>${i.nome}</strong>
<div class="actions">Editar</div>
</div>`;
lista.appendChild(d);
});
}

/* ===== CRIAR ===== */
imagem.onchange=e=>abrirCrop(e.target.files[0],blob=>{
croppedBlob=blob;
preview.src=URL.createObjectURL(blob);
preview.style.display="block";
uploadText.style.display="none";
});

async function salvar(){
overlay.style.display="flex";
let img=null;
if(croppedBlob){
const path=`${userId}/${Date.now()}.jpg`;
await sb.storage.from("produtos").upload(path,croppedBlob,{upsert:true});
img=sb.storage.from("produtos").getPublicUrl(path).data.publicUrl;
}
await sb.from("produtos_servicos").insert({
user_id:userId,nome:nome.value,descricao:descricao.value,
preco:+preco.value||0,custo:+custo.value||0,imagem_url:img
});
overlay.style.display="none";
carregar();
}

/* ===== MODAL ===== */
function abrirModal(i){
atual=i;
modal.style.display="flex";
mNome.value=i.nome;
mDescricao.value=i.descricao;
mPreco.value=i.preco;
mCusto.value=i.custo;
mPreview.src=i.imagem_url||"";
}

function fecharModal(){modal.style.display="none"}

async function salvarEdicao(){
overlay.style.display="flex";
await sb.from("produtos_servicos").update({
nome:mNome.value,descricao:mDescricao.value,
preco:+mPreco.value||0,custo:+mCusto.value||0
}).eq("id",atual.id);
overlay.style.display="none";
fecharModal();carregar();
}

async function excluir(){
if(!confirm("Excluir item?"))return;
await sb.from("produtos_servicos").delete().eq("id",atual.id);
fecharModal();carregar();
}

/* ===== CROP ===== */
function abrirCrop(file,cb){
const r=new FileReader();
r.onload=()=>{
cropImg.src=r.result;
cropModal.style.display="flex";
setTimeout(()=>cropper=new Cropper(cropImg,{aspectRatio:1}),100);
};
r.readAsDataURL(file);
window._cropCb=cb;
}
function confirmarCrop(){
cropper.getCroppedCanvas({width:400,height:400}).toBlob(b=>{
window._cropCb(b);
cropper.destroy();
cropModal.style.display="none";
});
}
function cancelarCrop(){
cropper.destroy();
cropModal.style.display="none";
}
</script>

</body>
</html>
