<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Produtos & Serviços • AgendaBeauty</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
--primary:#ff6a00;
--primary-soft:#fff1e6;
--bg:#f5f7fb;
--card:#ffffff;
--border:#e5e7eb;
--radius:14px;
--danger:#dc2626;
--success:#16a34a;
--warning:#f59e0b;
--muted:#6b7280;
--shadow:0 12px 30px rgba(0,0,0,.1)
}
*{margin:0;padding:0;box-sizing:border-box;font-family:Inter}
html,body{height:100%}
body{background:var(--bg);padding:18px;overflow:hidden}

/* HEADER */
.header{max-width:1700px;margin:auto}
.header h1{font-size:26px;font-weight:800}
.header span{color:var(--primary)}
.header p{font-size:12px;color:var(--muted)}

/* KPIs */
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:14px 0}
.kpi{background:var(--card);padding:16px;border-radius:14px;box-shadow:var(--shadow)}
.kpi small{font-size:11px;color:var(--muted);font-weight:600}
.kpi h2{font-size:22px;font-weight:800}

/* LAYOUT */
.container{
max-width:1700px;
margin:auto;
display:grid;
grid-template-columns:420px 1fr;
gap:18px;
height:calc(100vh - 180px)
}

/* CARD */
.card{
background:var(--card);
border-radius:14px;
padding:16px;
box-shadow:var(--shadow);
display:flex;
flex-direction:column;
overflow:hidden
}
.card h3{font-size:15px;font-weight:700;margin-bottom:10px}

/* FORM */
input,textarea,select{
width:100%;
height:36px;
padding:0 10px;
border-radius:10px;
border:1px solid var(--border);
font-size:12px;
margin-bottom:8px
}
textarea{height:auto;padding:8px;resize:none}
.row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.switch{display:flex;align-items:center;gap:6px;font-size:11px;margin:4px 0}
.switch input{width:14px;height:14px}

/* UPLOAD */
.upload{
border:2px dashed var(--border);
border-radius:10px;
padding:10px;
text-align:center;
cursor:pointer
}
.upload img{width:100%;height:90px;object-fit:cover;border-radius:8px}
.upload span{font-size:11px;color:var(--muted)}

/* BUTTON */
button{
height:42px;
border:none;
border-radius:22px;
background:linear-gradient(135deg,#ff6a00,#ff9a57);
color:#fff;
font-weight:800;
font-size:13px;
cursor:pointer;
margin-top:6px
}

/* FILTERS */
.filters{display:flex;gap:8px;margin-bottom:10px}
.filters input,.filters select{height:36px}

/* GRID */
.grid{
flex:1;
display:grid;
grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
gap:12px;
overflow-y:auto;
padding-right:6px
}
.grid::-webkit-scrollbar{width:5px}
.grid::-webkit-scrollbar-thumb{background:#d1d5db;border-radius:10px}

/* ITEM */
.item{
height:220px;
background:#fff;
border-radius:14px;
box-shadow:0 8px 22px rgba(0,0,0,.1);
overflow:hidden;
display:flex;
flex-direction:column;
transition:.2s
}
.item:hover{transform:translateY(-4px)}

/* IMAGE */
.image{
width:100%;
height:90px;
display:flex;
align-items:center;
justify-content:center;
background:linear-gradient(135deg,#f1f5f9,#e5e7eb)
}
.image img{width:100%;height:100%;object-fit:cover}
.image.no-image{
background:linear-gradient(135deg,#ff6a00,#ff9a57);
color:#fff;font-size:32px;font-weight:800
}

/* BODY */
.item-body{padding:10px;display:flex;flex-direction:column;gap:4px;flex:1}

/* BADGES */
.badges{display:flex;gap:4px;flex-wrap:wrap}
.badge{
font-size:9px;
padding:2px 7px;
border-radius:999px;
font-weight:700
}
.badge.promo{background:#fde7f3;color:#be185d}
.badge.off{background:#fee2e2;color:var(--danger)}
.badge.low{background:#fff3cd;color:var(--warning)}
.badge.ok{background:#dcfce7;color:var(--success)}

/* TEXT */
.item-body h4{font-size:12px;font-weight:700}
.price{font-size:14px;font-weight:800}
.actions{
margin-top:auto;
font-size:11px;
color:var(--primary);
font-weight:700;
cursor:pointer
}
</style>
</head>

<body>

<div class="header">
<h1>Produtos & <span>Serviços</span></h1>
<p>Gerencie serviços, produtos, estoque, promoções e preços</p>

<div class="kpis">
<div class="kpi"><small>Itens cadastrados</small><h2 id="kpiTotal">0</h2></div>
<div class="kpi"><small>Serviços ativos</small><h2 id="kpiServicos">0</h2></div>
<div class="kpi"><small>Estoque baixo</small><h2 id="kpiBaixo">0</h2></div>
<div class="kpi"><small>Promoções ativas</small><h2 id="kpiPromo">0</h2></div>
</div>
</div>

<div class="container">

<!-- FORM -->
<div class="card">
<h3>Cadastrar item</h3>
<select id="tipo"><option>SERVICO</option><option>PRODUTO</option></select>
<input id="nome" placeholder="Nome">
<textarea id="descricao" placeholder="Descrição"></textarea>
<input id="categoria" placeholder="Categoria">
<div class="row"><input id="preco" placeholder="Preço"><input id="custo" placeholder="Custo"></div>
<div class="row"><input id="precoPromo" placeholder="Preço promo"><input id="ordem" placeholder="Ordem"></div>
<label class="switch"><input type="checkbox" id="promoAtiva"> Promoção ativa</label>
<input id="duracao" placeholder="Duração (min)">
<div class="row"><input id="estoque" placeholder="Estoque"><input id="estoqueMin" placeholder="Estoque mínimo"></div>
<label class="switch"><input type="checkbox" id="controlaEstoque"> Controlar estoque</label>
<label class="switch"><input type="checkbox" id="ativo" checked> Ativo</label>
<label class="switch"><input type="checkbox" id="podeAgendar"> Disponível agenda</label>
<textarea id="obs" placeholder="Observações internas"></textarea>

<label class="upload" onclick="imagem.click()">
<img id="preview" style="display:none">
<span id="uploadText">Selecionar imagem</span>
<input id="imagem" type="file" hidden>
</label>

<button onclick="salvar()">Salvar</button>
</div>

<!-- LIST -->
<div class="card">
<div class="filters">
<input id="search" placeholder="Buscar" oninput="render()">
<select id="filtroTipo" onchange="render()">
<option value="">Todos</option>
<option>SERVICO</option>
<option>PRODUTO</option>
</select>
<select id="filtroEstoque" onchange="render()">
<option value="">Estoque</option>
<option value="BAIXO">Baixo</option>
<option value="OK">Ok</option>
</select>
</div>
<div class="grid" id="lista"></div>
</div>

</div>

<script>
const sb=supabase.createClient(
"https://egxjgmzukjyyxmkukwub.supabase.co",
"sb_publishable_EWwdrLOUk6KDHZGLuh4uRg_QDRtLeFi"
);

let itens=[],editId=null,userId=null;

(async()=>{
const{data:{session}}=await sb.auth.getSession();
if(!session)return;
userId=session.user.id;
carregar();
})();

async function carregar(){
const{data}=await sb.from("produtos_servicos").select("*").eq("user_id",userId);
itens=data||[];
atualizarKPIs();
render();
}

function atualizarKPIs(){
kpiTotal.innerText=itens.length;
kpiServicos.innerText=itens.filter(i=>i.tipo==="SERVICO"&&i.ativo).length;
kpiPromo.innerText=itens.filter(i=>i.promo_ativa).length;
kpiBaixo.innerText=itens.filter(i=>i.controla_estoque && i.estoque<=i.estoque_min).length;
}

function render(){
lista.innerHTML="";
const q=search.value.toLowerCase();
itens.filter(i=>{
if(q && !i.nome.toLowerCase().includes(q))return false;
if(filtroTipo.value && i.tipo!==filtroTipo.value)return false;
if(filtroEstoque.value==="BAIXO" && i.estoque>i.estoque_min)return false;
return true;
}).forEach(i=>{
lista.innerHTML+=`
<div class="item">
<div class="image ${i.imagem_url?'':'no-image'}">${i.imagem_url?`<img src="${i.imagem_url}">`:i.nome[0]}</div>
<div class="item-body">
<div class="badges">
${i.promo_ativa?'<span class="badge promo">Promo</span>':''}
${!i.ativo?'<span class="badge off">Inativo</span>':''}
${i.controla_estoque && i.estoque<=i.estoque_min?'<span class="badge low">Estoque baixo</span>':''}
</div>
<h4>${i.nome}</h4>
<div class="price">R$ ${i.preco||0}</div>
<div class="actions" onclick="editar('${i.id}')">Editar</div>
</div>
</div>`;
});
}

function editar(id){
const i=itens.find(x=>x.id===id);
editId=id;
for(let k in i){if(document.getElementById(k))document.getElementById(k).value=i[k]}
promoAtiva.checked=i.promo_ativa;
ativo.checked=i.ativo;
controlaEstoque.checked=i.controla_estoque;
podeAgendar.checked=i.pode_agendar;
}

async function salvar(){
let imagemUrl=null;
if(imagem.files[0]){
const nome=`${userId}/${Date.now()}_${imagem.files[0].name}`;
await sb.storage.from("produtos").upload(nome,imagem.files[0],{upsert:true});
imagemUrl=sb.storage.from("produtos").getPublicUrl(nome).data.publicUrl;
}

const dados={
user_id:userId,
tipo:tipo.value,
nome:nome.value,
descricao:descricao.value,
categoria:categoria.value,
preco:+preco.value||0,
custo:+custo.value||0,
preco_promo:+precoPromo.value||0,
promo_ativa:promoAtiva.checked,
duracao:+duracao.value||0,
estoque:+estoque.value||0,
estoque_min:+estoqueMin.value||0,
controla_estoque:controlaEstoque.checked,
ativo:ativo.checked,
pode_agendar:podeAgendar.checked,
obs:obs.value,
imagem_url:imagemUrl
};

editId
?await sb.from("produtos_servicos").update(dados).eq("id",editId)
:await sb.from("produtos_servicos").insert(dados);

editId=null;
carregar();
}
</script>

</body>
</html>
